<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Ï€-crust</title>

    <link rel="stylesheet" href="../dist/reset.css">
    <link rel="stylesheet" href="../dist/reveal.css">
    <link rel="stylesheet" href="../dist/custom.css">
    <link rel="stylesheet" href="../dist/theme/gruvbox.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="../plugin/highlight/gruvbox.css">
</head>
<body>
<div class="qr-container mobile-hide" style="position: relative">
    <img class="qr" alt="qr" src="../images/piecrust-qr.svg">
</div>

<div class="reveal">
    <div class="slides">
        <section>
            <h2>Ï€-crust</h2>
            Deterministic WASM virtual machine
        </section>
        <section>
            <h3>Harvard Architecture</h3>
            <section data-transition="fade">
                <img alt="arch" src="../images/arch.svg">
            </section>
            <section data-transition="fade">
                <img alt="arch-done" src="../images/arch-done.svg">
            </section>
            <section data-transition="fade">
                <img alt="arch-done-pie" src="../images/arch-done-pie.svg">
            </section>
        </section>
        <section>
            <img width="64em" alt="wasm" src="../images/wasm.svg">
            <section>
                WebAssembly is a binary instruction format for a stack-based
                virtual machine.
            </section>
            <section data-transition="none">
                Imports and Exports
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="">
                    (module
                        (func $log (import "env" "log") (param i32 i32))

                        (func (export "answer") (result i32)
                            i32.const 42
                        )
                        (func (export "log_hi")
                            i32.const 0
                            i32.const 2
                            call $log
                        )

                        (data (i32.const 0) "Hi")
                    )
                </code></pre>
            </section>
            <section data-transition="none">
                Imports and Exports
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="2">
                    (module
                        (func $log (import "env" "log") (param i32 i32))

                        (func (export "answer") (result i32)
                            i32.const 42
                        )
                        (func (export "log_hi")
                            i32.const 0
                            i32.const 2
                            call $log
                        )

                        (data (i32.const 0) "Hi")
                    )
                </code></pre>
            </section>
            <section data-transition="none">
                Imports and Exports
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="4-6">
                    (module
                        (func $log (import "env" "log") (param i32 i32))

                        (func (export "answer") (result i32)
                            i32.const 42
                        )
                        (func (export "log_hi")
                            i32.const 0
                            i32.const 2
                            call $log
                        )

                        (data (i32.const 0) "Hi")
                    )
                </code></pre>
            </section>
            <section data-transition="none">
                Imports and Exports
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="7-13">
                    (module
                        (func $log (import "env" "log") (param i32 i32))

                        (func (export "answer") (result i32)
                            i32.const 42
                        )
                        (func (export "log_hi")
                            i32.const 0
                            i32.const 2
                            call $log
                        )

                        (data (i32.const 0) "Hi")
                    )
                </code></pre>
            </section>
            <section data-transition="none">
                Memory Definition
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="2-3,13">
                    (module
                        (memory $memory 1)
                        (export "memory" (memory $memory))
                        (func (export "increment")
                            i32.const 0
                            i32.const 0
                            i32.load
                            i32.const 4
                            i32.load
                            i32.add
                            i32.store
                        )
                        (data (i32.const 0) "\00\00\00\00\01\00\00\00")
                    )
                </code></pre>
            </section>
            <section data-transition="none">
                Loads and Stores
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="4-12">
                    (module
                        (memory $memory 1)
                        (export "memory" (memory $memory))
                        (func (export "increment")
                            i32.const 0
                            i32.const 0
                            i32.load
                            i32.const 4
                            i32.load
                            i32.add
                            i32.store
                        )
                        (data (i32.const 0) "\00\00\00\00\01\00\00\00")
                    )
                </code></pre>
            </section>
            <section data-transition="none">
                Size and Growth
                <pre><code class="language-wasm" data-trim data-noescape data-line-numbers="5-11">
                    (module
                        (memory $memory 1)
                        (export "memory" (memory $memory))

                        (func (export "grow" (param i32) (result i32)
                            local.get 0
                            memory.grow
                        )
                        (func (export "size" (result i32)
                            memory.size
                        )

                        (data (i32.const 0) "\00\00\00\00\01\00\00\00")
                    )
                </code></pre>
            </section>
        </section>
        <section>
            <img width="256em" alt="wasm" src="../images/wasmer.svg">
            <section data-transition="fade">
                ðŸš€ The leading WebAssembly Runtime supporting WASIX, WASI and Emscripten
            </section>
            <section data-transition="fade">
                <br>
                <br>
                <pre><code class="language-wasm" data-trim data-noescape>
                                              (; WAT ;)
                    (func (export "increment")
                        i32.const 0
                        i32.const 0
                        i32.load
                        i32.const 1
                        i32.add
                        i32.store
                    )
                </code></pre>
                <pre><code class="language-x86asm" data-trim data-noescape>
                                           ; Firefox x86 ;
                    increment:
                        sub rsp, 8               ; 0x000000 48 83 ec 08
                        mov eax, dword ptr [r15] ; 0x000004 41 8b 07
                        add eax, 1               ; 0x000007 83 c0 01
                        mov dword ptr [r15], eax ; 0x00000a 41 89 07
                        nop                      ; 0x00000d 66 90
                        add rsp, 8               ; 0x00000f 48 83 c4 08
                        ret                      ; 0x000013 c3
                        </code></pre>
            </section>
            <section data-transition="fade">
                <h4>Features</h4>
                <ul>
                    <li class="fragment fade-up"><b>Secure</b> by default. No file, network, or environment access,
                        unless explicitly enabled.
                    </li>
                    <li class="fragment fade-up"><b>Fast</b>. Run WebAssembly at near-native speeds.</li>
                    <li class="fragment fade-up"><b>Pluggable</b>. Embeddable in multiple programming languages.</li>
                </ul>
            </section>
            <section data-transition="fade">
                <h4>Native Backends</h4>
                <ul>
                    <li class="fragment fade-up"><b>Singlepass</b>: A single-pass compiler for fast compilation times
                        and low memory usage.
                    </li>
                    <li class="fragment fade-up"><b>Cranelift</b>: A fast compiler backend with a focus on compile
                        times, and runtime performance.
                    </li>
                    <li class="fragment fade-up"><b>LLVM</b>: A compiler backend that uses LLVM for optimization and
                        code generation.
                    </li>
                </ul>
            </section>
        </section>
        <section>
            <h3>Calling Convention</h3>
            <section>
            </section>
            <section data-transition="fade">
                <h4>Questions</h4>
                <ul>
                    <li class="fragment fade-up">What imports does the VM offer?</li>
                    <li class="fragment fade-up">What exports does the VM support?</li>
                </ul>
            </section>
            <section data-transition="none">
                <h4>Argument Buffer</h4>
                <img alt="argbuf" src="../images/argbuf.svg">
            </section>
            <section data-transition="none">
                <h4>Argument Buffer</h4>
                <img alt="argbuf-inv" src="../images/argbuf-inv.svg">
            </section>
            <section data-transition="fade">
                <h4>Exports</h4>

                <pre><code class="language-rust" data-trim data-noescape>
                    fn correct(arg_len: u32) -> u32 {
                        todo!()
                    }

                    fn incorrect(arg_len: u32, no: u8) -> u32 {
                        todo!()
                    }

                    fn also_incorrect(arg_len: u32) -> u64 {
                        todo!()
                    }
                </code></pre>
            </section>
            <section data-transition="none">
                <h4>Imports</h4>

                <pre><code class="language-rust" data-trim data-noescape>
                    //! Fixed size returns

                    /// Emplaces the caller of the contract into the arg buffer.
                    fn caller();

                    /// Emplaces the ID of the calling contract into the arg
                    /// buffer.
                    fn self_id();

                    /// Emplaces the owner of the calling contract into the arg
                    /// buffer.
                    fn owner();
                </code></pre>
            </section>
            <section data-transition="none">
                <h4>Imports</h4>

                <pre><code class="language-rust" data-trim data-noescape>
                    //! Host data and host queries

                    /// Emplaces the result of executing a host query with the
                    /// given arguments to the arg buffer.
                    ///
                    /// This allows for defining some additional functionality
                    /// downstream in rusk - `verify_proof` is a good example.
                    fn hq(name: *const u8, name_len: u32, arg_len: u32) -> u32;

                    /// Emplaces some metadata provided by the host into the
                    /// argument buffer.
                    fn hd(name: *const u8, name_len: u32) -> u32;
                </code></pre>
            </section>
            <section data-transition="none">
                <br><br>
                <h4>Imports</h4>
                <pre><code class="language-rust" data-trim data-noescape>
                    /// Calls another contract's export with the an argument
                    /// with the given length in the arg buffer.
                    fn c(
                        contract_id: *const u8,
                        fn_name: *const u8,
                        fn_name_len: u32,
                        fn_arg_len: u32,
                        points_limit: u64,
                    ) -> i32;
                </code></pre>
                <img alt="contract-call" src="../images/contract-call.svg">
            </section>
            <section data-transition="none">
                <h4>Imports</h4>
                <pre><code class="language-rust" data-trim data-noescape>
                    //! Events and feeds

                    /// Emits an event with the given topic and argument - for
                    /// when the contract want to inform external applications.
                    fn emit(topic: *const u8, topic_len: u32, arg_len: u32);

                    /// Feeds the given argument to the contract - for when the
                    /// host needs to take more data than allowed by the arg
                    /// buffer.
                    fn feed(arg_len: u32);
                </code></pre>
            </section>
            <section data-transition="none">
                <h4>Imports</h4>
                <pre><code class="language-rust" data-trim data-noescape>
                    //! Points - related to instruction metering

                    /// The set execution points limit for this call.
                    fn limit() -> u64;

                    /// The number of execution points spent so far.
                    fn spent() -> u64;
                </code></pre>
            </section>
            <section data-transition="none">
                <h4>Imports</h4>
                <pre><code class="language-rust" data-trim data-noescape>
                    //! Debugging

                    /// Logs the argument to STDOUT.
                    ///
                    /// Only available with the `debug` feature.
                    fn hdebug(arg_len: u32);

                    /// Allows the contract to signal a panic to the host.
                    fn panic(arg_len: u32);
                </code></pre>
            </section>
        </section>
        <section>
            <h3>State</h3>
            <section data-transition="none">
                <img alt="memory" src="../images/memory.svg">
            </section>
            <section data-transition="none">
                <img alt="memory-tree" src="../images/memory-tree.svg">
            </section>
            <section data-transition="none">
                <img alt="memory-tree-dirty" src="../images/memory-tree-dirty.svg">
            </section>
            <section data-transition="none">
                <img alt="contracts-tree" src="../images/contracts-tree.svg">
            </section>
        </section>
        <section>
            <h3>Atomicity</h3>
            <section data-transition="none">
                <img alt="memory" src="../images/call-tree.svg">
            </section>
            <section data-transition="none">
                <img alt="memory" src="../images/call-tree-pruned.svg">
            </section>
            <section data-transition="none">
                <img alt="memory" src="../images/call-tree-pruned-snap.svg">
            </section>
        </section>
    </div>
</div>

<script src="../dist/reveal.js"></script>
<script src="../plugin/notes/notes.js"></script>
<script src="../plugin/markdown/markdown.js"></script>
<script src="../plugin/highlight/highlight.js"></script>

<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
</script>
</body>
</html>
